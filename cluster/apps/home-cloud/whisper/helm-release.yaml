---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: whisper
  namespace: home-cloud
spec:
  chart:
    spec:
      chart: app-template
      version: 1.5.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  interval: 10m0s
  values:
    image:
      repository: rhasspy/wyoming-whisper
      tag: latest
      pullPolicy: Always
    strategy:
      type: Recreate
    env:
      TZ: ${TIMEZONE}
    args:
      - --model
        # tiny-int8 (43 MB)
        # tiny (152 MB)
        # base-int8 (80 MB)
        # base (291 MB)
        # small-int8 (255 MB)
        # small (968 MB)
        # medium-int8 (786 MB)
        # medium (3.1 GB)
      - small
      - --language
      - it
    service:
      main:
        ports:
          http:
            enabled: false
          tcp:
            enabled: true
            primary: true
            port: 10300
            protocol: TCP
    persistence:
      config:
        enabled: true
        mountPath: /data
        type: emptyDir
    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            preference:
              matchExpressions:
                - key: kubernetes.io/arch
                  operator: In
                  values:
                    - amd64
